services:
    _defaults:
        autowire: true
        autoconfigure: true
        public: false

    # Services disponibles pour l'autowiring
    CorentinBoutillier\InvoiceBundle\Service\:
        resource: '../src/Service/*'

    CorentinBoutillier\InvoiceBundle\Repository\:
        resource: '../src/Repository/*'
        tags: ['doctrine.repository_service']

    CorentinBoutillier\InvoiceBundle\EventSubscriber\:
        resource: '../src/EventSubscriber/*'
        tags: ['kernel.event_subscriber']

    CorentinBoutillier\InvoiceBundle\Validator\:
        resource: '../src/Validator/*'

    CorentinBoutillier\InvoiceBundle\Command\:
        resource: '../src/Command/*'
        tags: ['console.command']

    # Make ExportFecCommand public for testing
    CorentinBoutillier\InvoiceBundle\Command\ExportFecCommand:
        public: true

    # Alias for interface to implementation
    CorentinBoutillier\InvoiceBundle\Service\NumberGenerator\InvoiceNumberGeneratorInterface:
        alias: CorentinBoutillier\InvoiceBundle\Service\NumberGenerator\InvoiceNumberGenerator
        public: false

    CorentinBoutillier\InvoiceBundle\Service\PaymentManagerInterface:
        alias: CorentinBoutillier\InvoiceBundle\Service\PaymentManager
        public: false

    CorentinBoutillier\InvoiceBundle\Service\Pdf\TwigPdfGenerator:
        arguments:
            $twig: '@twig'
            $templatePath: '@@InvoiceBundle/invoice/pdf.html.twig'

    CorentinBoutillier\InvoiceBundle\Service\Pdf\PdfGeneratorInterface:
        alias: CorentinBoutillier\InvoiceBundle\Service\Pdf\TwigPdfGenerator
        public: false

    CorentinBoutillier\InvoiceBundle\Service\Pdf\Storage\FilesystemPdfStorage:
        arguments:
            $basePath: '%invoice.pdf.storage_path%'

    CorentinBoutillier\InvoiceBundle\Service\Pdf\Storage\PdfStorageInterface:
        alias: CorentinBoutillier\InvoiceBundle\Service\Pdf\Storage\FilesystemPdfStorage
        public: true

    CorentinBoutillier\InvoiceBundle\Service\InvoiceManagerInterface:
        alias: CorentinBoutillier\InvoiceBundle\Service\InvoiceManager
        public: true

    CorentinBoutillier\InvoiceBundle\Service\InvoiceFinalizerInterface:
        alias: CorentinBoutillier\InvoiceBundle\Service\InvoiceFinalizer
        public: true

    # Company Provider (configuration-based)
    CorentinBoutillier\InvoiceBundle\Provider\ConfigCompanyProvider:
        arguments:
            $config: '%invoice.company%'
        public: true

    CorentinBoutillier\InvoiceBundle\Provider\CompanyProviderInterface:
        alias: CorentinBoutillier\InvoiceBundle\Provider\ConfigCompanyProvider
        public: true

    # Due Date Calculator
    CorentinBoutillier\InvoiceBundle\Service\DueDateCalculatorInterface:
        alias: CorentinBoutillier\InvoiceBundle\Service\DueDateCalculator
        public: false

    # FEC Exporter with accounting configuration
    CorentinBoutillier\InvoiceBundle\Service\Fec\FecExporter:
        arguments:
            $customerAccount: '%invoice.accounting.customer_account%'
            $salesAccount: '%invoice.accounting.sales_account%'
            $vatCollectedAccount: '%invoice.accounting.vat_collected_account%'
            $journalCode: '%invoice.accounting.journal_code%'
            $journalLabel: '%invoice.accounting.journal_label%'

    CorentinBoutillier\InvoiceBundle\Service\Fec\FecExporterInterface:
        alias: CorentinBoutillier\InvoiceBundle\Service\Fec\FecExporter
        public: true

    # Factur-X Services
    CorentinBoutillier\InvoiceBundle\Service\FacturX\FacturXConfigProvider:
        arguments:
            $enabled: '%invoice.factur_x.enabled%'
            $profile: '%invoice.factur_x.profile%'
            $xmlFilename: '%invoice.factur_x.xml_filename%'
            $validateXml: '%invoice.factur_x.validate_xml%'

    CorentinBoutillier\InvoiceBundle\Service\FacturX\FacturXConfigProviderInterface:
        alias: CorentinBoutillier\InvoiceBundle\Service\FacturX\FacturXConfigProvider
        public: false

    # Factur-X XML Builders (tagged for factory)
    CorentinBoutillier\InvoiceBundle\Service\FacturX\FacturXXmlBuilder:
        tags: ['invoice.facturx_builder']

    CorentinBoutillier\InvoiceBundle\Service\FacturX\FacturXEN16931XmlBuilder:
        tags: ['invoice.facturx_builder']

    # Factur-X XML Builder Factory (collects tagged builders)
    CorentinBoutillier\InvoiceBundle\Service\FacturX\FacturXXmlBuilderFactory:
        arguments:
            $builders: !tagged_iterator invoice.facturx_builder

    CorentinBoutillier\InvoiceBundle\Service\FacturX\PdfA3Converter: ~

    CorentinBoutillier\InvoiceBundle\Service\FacturX\PdfA3ConverterInterface:
        alias: CorentinBoutillier\InvoiceBundle\Service\FacturX\PdfA3Converter
        public: false

    # XML Validation Services
    CorentinBoutillier\InvoiceBundle\Service\Validation\FacturXXmlValidator: ~

    CorentinBoutillier\InvoiceBundle\Service\Validation\XmlValidatorInterface:
        alias: CorentinBoutillier\InvoiceBundle\Service\Validation\FacturXXmlValidator
        public: false

    # PDP (Plateforme de Dématérialisation Partenaire) Services
    CorentinBoutillier\InvoiceBundle\Pdp\:
        resource: '../src/Pdp/*'
        exclude: '../src/Pdp/{Dto,Enum,Exception}/*'

    CorentinBoutillier\InvoiceBundle\Pdp\PdpDispatcher:
        arguments:
            $connectors: !tagged_iterator invoice.pdp_connector
            $defaultConnectorId: '%invoice.pdp.default_connector%'
        public: true

    CorentinBoutillier\InvoiceBundle\Pdp\PdpDispatcherInterface:
        alias: CorentinBoutillier\InvoiceBundle\Pdp\PdpDispatcher
        public: false

    CorentinBoutillier\InvoiceBundle\Pdp\Connector\NullConnector:
        tags: ['invoice.pdp_connector']

    # E-Reporting Services
    CorentinBoutillier\InvoiceBundle\EReporting\:
        resource: '../src/EReporting/*'
        exclude: '../src/EReporting/{Dto,Enum}/*'

    CorentinBoutillier\InvoiceBundle\EReporting\EReportingServiceInterface:
        alias: CorentinBoutillier\InvoiceBundle\EReporting\EReportingService
        public: false

    # PDP Event Subscriber
    CorentinBoutillier\InvoiceBundle\EventSubscriber\InvoicePdpSubscriber:
        arguments:
            $pdpEnabled: '%invoice.pdp.enabled%'
            $autoSendOnFinalize: '%invoice.pdp.auto_send_on_finalize%'
            $defaultConnectorId: '%invoice.pdp.default_connector%'
            $logger: '@?logger'
        tags: ['kernel.event_subscriber']

    # User Provider (default implementation using Symfony Security)
    CorentinBoutillier\InvoiceBundle\Provider\SecurityUserProvider:
        arguments:
            $security: '@?security.helper'  # Optional - null if security-bundle not installed

    CorentinBoutillier\InvoiceBundle\Provider\UserProviderInterface:
        alias: CorentinBoutillier\InvoiceBundle\Provider\SecurityUserProvider
        public: false
