# TODO - Invoice Bundle Implementation (TDD & DRY)

## Principes
- ‚úÖ **TDD** : Test-Driven Development - Tests AVANT le code
- ‚úÖ **DRY** : Don't Repeat Yourself - √âviter toute duplication
- ‚úÖ **Qualit√© d√®s le d√©but** : PHPStan 9, CS Fixer, couverture 100%

---

## Progression globale
- [x] Phase 0 : Setup Qualit√© & Tests (5 t√¢ches) - T√¢ches 1-5
- [ ] Phase 1 : Enums - TDD (8 t√¢ches) - T√¢ches 6-13
- [ ] Phase 2 : DTOs - TDD (4 t√¢ches) - T√¢ches 14-17
- [ ] Phase 3 : Entit√©s - TDD (22 t√¢ches) - T√¢ches 18-39
- [ ] Phase 4 : Repositories - TDD (4 t√¢ches) - T√¢ches 40-43
- [ ] Phase 5 : Providers & Interfaces - TDD (5 t√¢ches) - T√¢ches 44-48
- [ ] Phase 6 : Events & Subscribers - TDD (3 t√¢ches) - T√¢ches 49-51
- [ ] Phase 7 : Services M√©tier - TDD (16 t√¢ches) - T√¢ches 52-67
- [ ] Phase 8 : Features Avanc√©es - TDD (8 t√¢ches) - T√¢ches 68-75
- [ ] Phase 9 : Configuration & Int√©gration - TDD (5 t√¢ches) - T√¢ches 76-80
- [ ] Phase 10 : Documentation & Validation finale (4 t√¢ches) - T√¢ches 81-84

---

## üîß Phase 0 : Setup Qualit√© & Tests

**Objectif** : Pr√©parer l'environnement qualit√© AVANT d'√©crire du code

- [x] 1. V√©rifier et ajuster phpstan.neon (niveau 9)
  - R√®gles strictes activ√©es
  - Exclusions justifi√©es uniquement

- [x] 2. V√©rifier et ajuster .php-cs-fixer.dist.php
  - R√®gles Symfony
  - declare(strict_types=1)
  - Trailing commas

- [x] 3. Configurer phpunit.xml.dist
  - Bootstrap
  - Couverture de code
  - Strict mode

- [x] 4. Cr√©er le TestKernel et bootstrap pour tests
  - D√©j√† fait, v√©rifier

- [x] 5. Valider que les outils fonctionnent
  - `make phpstan` ‚Üí OK
  - `make cs-check` ‚Üí OK
  - `make test-unit` ‚Üí OK (m√™me vide)

---

## üìê Phase 1 : Enums - TDD

### InvoiceStatus

- [ ] 6. TEST : √âcrire les tests pour InvoiceStatus
  - `tests/Unit/Enum/InvoiceStatusTest.php`
  - Tous les cas disponibles
  - Values correctes

- [ ] 7. CODE : Impl√©menter InvoiceStatus
  - `src/Enum/InvoiceStatus.php`
  - Les tests doivent passer

### InvoiceType

- [ ] 8. TEST : √âcrire les tests pour InvoiceType
  - `tests/Unit/Enum/InvoiceTypeTest.php`

- [ ] 9. CODE : Impl√©menter InvoiceType
  - `src/Enum/InvoiceType.php`

### PaymentMethod

- [ ] 10. TEST : √âcrire les tests pour PaymentMethod
  - `tests/Unit/Enum/PaymentMethodTest.php`

- [ ] 11. CODE : Impl√©menter PaymentMethod
  - `src/Enum/PaymentMethod.php`

### InvoiceHistoryAction

- [ ] 12. TEST : √âcrire les tests pour InvoiceHistoryAction
  - `tests/Unit/Enum/InvoiceHistoryActionTest.php`

- [ ] 13. CODE : Impl√©menter InvoiceHistoryAction
  - `src/Enum/InvoiceHistoryAction.php`

**‚úì Validation Phase 1** : PHPStan + CS Fixer + Tests 100%

---

## üì¶ Phase 2 : DTOs - TDD

### CompanyData

- [ ] 14. TEST : √âcrire les tests pour CompanyData
  - `tests/Unit/DTO/CompanyDataTest.php`
  - Construction
  - Tous les champs

- [ ] 15. CODE : Impl√©menter CompanyData
  - `src/DTO/CompanyData.php`
  - Readonly properties

### CustomerData

- [ ] 16. TEST : √âcrire les tests pour CustomerData
  - `tests/Unit/DTO/CustomerDataTest.php`

- [ ] 17. CODE : Impl√©menter CustomerData
  - `src/DTO/CustomerData.php`

**‚úì Validation Phase 2** : PHPStan + CS Fixer + Tests 100%

---

## üóÑÔ∏è Phase 3 : Entit√©s - TDD

### InvoiceSequence

- [ ] 18. TEST : √âcrire les tests pour InvoiceSequence
  - `tests/Unit/Entity/InvoiceSequenceTest.php`
  - Contrainte unique
  - Incr√©mentation

- [ ] 19. CODE : Impl√©menter InvoiceSequence
  - `src/Entity/InvoiceSequence.php`

### InvoiceLine (calculs simples d'abord)

- [ ] 20. TEST : Tests pour InvoiceLine (sans remises)
  - `tests/Unit/Entity/InvoiceLineTest.php`
  - Cr√©ation
  - Total HT simple (quantit√© √ó prix)

- [ ] 21. CODE : Impl√©menter InvoiceLine (structure de base)
  - `src/Entity/InvoiceLine.php`
  - Champs de base, pas encore de calculs complexes

- [ ] 22. TEST : Tests pour remises sur InvoiceLine
  - Remise en %
  - Remise en montant fixe
  - Prix apr√®s remise
  - Total HT apr√®s remise

- [ ] 23. CODE : Ajouter les m√©thodes de calcul des remises
  - `getUnitPriceAfterDiscount()`
  - `getTotalBeforeVat()`

- [ ] 24. TEST : Tests pour TVA sur InvoiceLine
  - Calcul montant TVA
  - Total TTC

- [ ] 25. CODE : Ajouter les m√©thodes de calcul TVA
  - `getVatAmount()`
  - `getTotalIncludingVat()`

### Payment

- [ ] 26. TEST : Tests pour Payment
  - `tests/Unit/Entity/PaymentTest.php`
  - Cr√©ation
  - Relation Invoice

- [ ] 27. CODE : Impl√©menter Payment
  - `src/Entity/Payment.php`
  - Extensible (SINGLE_TABLE inheritance)

### Invoice (structure puis calculs)

- [ ] 28. TEST : Tests pour Invoice (structure de base)
  - `tests/Unit/Entity/InvoiceTest.php`
  - Cr√©ation
  - Ajout de lignes
  - Ajout de paiements

- [ ] 29. CODE : Impl√©menter Invoice (structure de base)
  - `src/Entity/Invoice.php`
  - Champs, relations, pas encore de calculs

- [ ] 30. TEST : Tests pour calculs simples Invoice
  - Sous-total (somme lignes HT)
  - Total TVA
  - Total TTC

- [ ] 31. CODE : Impl√©menter calculs simples
  - `getSubtotalBeforeDiscount()`
  - `getTotalVat()`
  - `getTotalIncludingVat()`

- [ ] 32. TEST : Tests pour remise globale Invoice
  - Remise globale %
  - Remise globale montant
  - Total apr√®s remise globale

- [ ] 33. CODE : Impl√©menter remise globale
  - `getGlobalDiscountValue()`
  - `getTotalExcludingVat()`

- [ ] 34. TEST : Tests pour paiements Invoice
  - Total pay√©
  - Reste √† payer
  - isFullyPaid()
  - isPartiallyPaid()

- [ ] 35. CODE : Impl√©menter m√©thodes paiements
  - `getTotalPaid()`
  - `getRemainingAmount()`
  - `isFullyPaid()`
  - `isPartiallyPaid()`

- [ ] 36. TEST : Tests pour √©ch√©ances Invoice
  - isOverdue()
  - getDaysOverdue()

- [ ] 37. CODE : Impl√©menter m√©thodes √©ch√©ances
  - `isOverdue()`
  - `getDaysOverdue()`

### InvoiceHistory

- [ ] 38. TEST : Tests pour InvoiceHistory
  - `tests/Unit/Entity/InvoiceHistoryTest.php`
  - Cr√©ation
  - Donn√©es JSON

- [ ] 39. CODE : Impl√©menter InvoiceHistory
  - `src/Entity/InvoiceHistory.php`

**‚úì Validation Phase 3** : PHPStan + CS Fixer + Tests 100%

---

## üìÇ Phase 4 : Repositories - TDD

- [ ] 40. TEST : Tests pour InvoiceRepository
  - `tests/Functional/Repository/InvoiceRepositoryTest.php`
  - M√©thodes custom de recherche

- [ ] 41. CODE : Impl√©menter InvoiceRepository
  - `src/Repository/InvoiceRepository.php`
  - Requ√™tes optimis√©es

- [ ] 42. TEST : Tests pour InvoiceSequenceRepository
  - Lock pour num√©rotation
  - findForUpdate()

- [ ] 43. CODE : Impl√©menter InvoiceSequenceRepository
  - `src/Repository/InvoiceSequenceRepository.php`

**Note** : PaymentRepository et InvoiceHistoryRepository basiques (pas de tests si pas de logique custom)

**‚úì Validation Phase 4** : PHPStan + CS Fixer + Tests 100%

---

## üîå Phase 5 : Providers & Interfaces - TDD

### CompanyProvider

- [ ] 44. TEST : Tests pour ConfigCompanyProvider
  - `tests/Unit/Provider/ConfigCompanyProviderTest.php`
  - Mock de configuration
  - Les tests d√©finissent le contrat de l'interface

- [ ] 45. CODE : Cr√©er interface CompanyProviderInterface + impl√©mentation
  - `src/Provider/CompanyProviderInterface.php`
  - `src/Provider/ConfigCompanyProvider.php`
  - Les tests doivent passer

### UserProvider

- [ ] 46. CODE : Cr√©er interface UserProviderInterface (simple contrat, pas d'impl√©mentation)
  - `src/Provider/UserProviderInterface.php`
  - Sera impl√©ment√© par l'app cliente

### DueDateCalculator

- [ ] 47. TEST : Tests pour DueDateCalculator
  - `tests/Unit/Service/DueDateCalculatorTest.php`
  - 30j net
  - 45j fin de mois
  - Comptant
  - Les tests d√©finissent le contrat de l'interface

- [ ] 48. CODE : Cr√©er interface + impl√©mentation DueDateCalculator
  - `src/Service/DueDateCalculatorInterface.php`
  - `src/Service/DueDateCalculator.php`
  - Les tests doivent passer

**‚úì Validation Phase 5** : PHPStan + CS Fixer + Tests 100%

---

## üîî Phase 6 : Events & Subscribers - TDD

### InvoiceHistorySubscriber (TDD)

- [ ] 49. TEST : Tests pour InvoiceHistorySubscriber
  - `tests/Unit/EventSubscriber/InvoiceHistorySubscriberTest.php`
  - Mock des Events (d√©finir leur structure dans les tests)
  - Mock EventDispatcher
  - V√©rifier enregistrement history pour chaque type d'event

- [ ] 50. CODE : Cr√©er les Events n√©cessaires
  - `src/Event/InvoiceCreatedEvent.php`
  - `src/Event/InvoiceUpdatedEvent.php`
  - `src/Event/InvoiceFinalizedEvent.php`
  - `src/Event/InvoiceStatusChangedEvent.php`
  - `src/Event/InvoicePaidEvent.php`
  - `src/Event/InvoicePartiallyPaidEvent.php`
  - `src/Event/InvoiceOverdueEvent.php`
  - `src/Event/InvoiceCancelledEvent.php`
  - `src/Event/CreditNoteCreatedEvent.php`
  - `src/Event/InvoicePdfGeneratedEvent.php`
  - Structure d√©finie par les tests

- [ ] 51. CODE : Impl√©menter InvoiceHistorySubscriber
  - `src/EventSubscriber/InvoiceHistorySubscriber.php`
  - Les tests doivent passer

**‚úì Validation Phase 6** : PHPStan + CS Fixer + Tests 100%

---

## ‚öôÔ∏è Phase 7 : Services M√©tier - TDD

### InvoiceNumberGenerator

- [ ] 52. TEST : Tests pour InvoiceNumberGenerator
  - `tests/Functional/Service/NumberGenerator/InvoiceNumberGeneratorTest.php`
  - Format par d√©faut
  - Exercice comptable
  - S√©quence par soci√©t√©
  - Thread-safe (concurrence)
  - Les tests d√©finissent le contrat de l'interface

- [ ] 53. CODE : Cr√©er interface + impl√©mentation InvoiceNumberGenerator
  - `src/Service/NumberGenerator/InvoiceNumberGeneratorInterface.php`
  - `src/Service/NumberGenerator/InvoiceNumberGenerator.php`
  - Lock Doctrine
  - Calcul exercice comptable
  - Les tests doivent passer

### PaymentManager

- [ ] 54. TEST : Tests pour PaymentManager
  - `tests/Functional/Service/PaymentManagerTest.php`
  - Enregistrement paiement
  - Mise √† jour statut
  - Events dispatch√©
  - Les tests d√©finissent le contrat

- [ ] 55. CODE : Impl√©menter PaymentManager
  - `src/Service/PaymentManager.php`
  - Les tests doivent passer

### PdfGenerator

- [ ] 56. TEST : Tests pour TwigPdfGenerator
  - `tests/Functional/Service/Pdf/TwigPdfGeneratorTest.php`
  - G√©n√©ration PDF
  - Contenu pr√©sent (donn√©es facture)
  - Format correct
  - Les tests d√©finissent le contrat de l'interface

- [ ] 57. CODE : Cr√©er template Twig + interface + impl√©mentation
  - `templates/invoice/pdf.html.twig` (blocs overridables)
  - `src/Service/Pdf/PdfGeneratorInterface.php`
  - `src/Service/Pdf/TwigPdfGenerator.php`
  - Integration DomPDF
  - Les tests doivent passer

### PdfStorage

- [ ] 58. TEST : Tests pour FilesystemPdfStorage
  - `tests/Functional/Service/Pdf/Storage/FilesystemPdfStorageTest.php`
  - Store
  - Retrieve
  - Organisation par date
  - Les tests d√©finissent le contrat de l'interface

- [ ] 59. CODE : Cr√©er interface + impl√©mentation FilesystemPdfStorage
  - `src/Service/Pdf/Storage/PdfStorageInterface.php`
  - `src/Service/Pdf/Storage/FilesystemPdfStorage.php`
  - Les tests doivent passer

### InvoiceManager

- [ ] 60. TEST : Tests pour InvoiceManager (cr√©ation)
  - `tests/Functional/Service/InvoiceManagerTest.php`
  - Cr√©ation facture
  - Cr√©ation avoir
  - Ajout lignes
  - Calculs automatiques

- [ ] 61. CODE : Impl√©menter InvoiceManager (partie cr√©ation)
  - `src/Service/InvoiceManager.php`
  - createInvoice()
  - createCreditNote()
  - addLine()
  - Les tests doivent passer

- [ ] 62. TEST : Tests pour InvoiceManager (mise √† jour)
  - Modification brouillon
  - Interdiction modification finalis√©e

- [ ] 63. CODE : Impl√©menter InvoiceManager (mise √† jour)
  - updateInvoice()
  - Validations
  - Les tests doivent passer

- [ ] 64. TEST : Tests pour InvoiceManager (annulation)
  - Annulation avec raison
  - Event dispatch√©

- [ ] 65. CODE : Impl√©menter InvoiceManager (annulation)
  - cancelInvoice()
  - Les tests doivent passer

### InvoiceFinalizer

- [ ] 66. TEST : Tests pour InvoiceFinalizer
  - `tests/Functional/Service/InvoiceFinalizerTest.php`
  - Finalisation compl√®te
  - Transaction atomique
  - Rollback sur √©chec PDF
  - Rollback sur √©chec storage
  - Num√©ro attribu√©
  - PDF g√©n√©r√© et stock√©
  - Events

- [ ] 67. CODE : Impl√©menter InvoiceFinalizer
  - `src/Service/InvoiceFinalizer.php`
  - Transaction compl√®te
  - Gestion erreurs
  - Les tests doivent passer

**‚úì Validation Phase 7** : PHPStan + CS Fixer + Tests 100%

---

## üöÄ Phase 8 : Features Avanc√©es - TDD

### Factur-X

- [ ] 68. TEST : Tests pour FacturXGenerator
  - `tests/Functional/Service/FacturX/FacturXGeneratorTest.php`
  - G√©n√©ration XML
  - Embarquement dans PDF
  - Validation format EN 16931
  - Les tests d√©finissent le contrat de l'interface

- [ ] 69. CODE : Cr√©er interface + impl√©mentation FacturXGenerator
  - `src/Service/FacturX/FacturXGeneratorInterface.php`
  - `src/Service/FacturX/FacturXGenerator.php`
  - XML EN 16931
  - Profiles (BASIC, etc.)
  - Les tests doivent passer

- [ ] 70. TEST : Tests pour int√©gration Factur-X dans InvoiceFinalizer
  - Factur-X activ√© ‚Üí PDF avec XML
  - Factur-X d√©sactiv√© ‚Üí PDF standard

- [ ] 71. CODE : Int√©grer Factur-X dans InvoiceFinalizer
  - Option config facturx.enabled
  - Utiliser FacturXGenerator si activ√©
  - Les tests doivent passer

### Export FEC

- [ ] 72. TEST : Tests pour FecExporter
  - `tests/Functional/Service/Fec/FecExporterTest.php`
  - Format CSV correct
  - 18 colonnes conformes
  - S√©parateur |
  - Calculs corrects
  - Les tests d√©finissent le contrat de l'interface

- [ ] 73. CODE : Cr√©er interface + impl√©mentation FecExporter
  - `src/Service/Fec/FecExporterInterface.php`
  - `src/Service/Fec/FecExporter.php`
  - Les tests doivent passer

- [ ] 74. TEST : Tests pour ExportFecCommand
  - `tests/Functional/Command/ExportFecCommandTest.php`
  - Arguments (exercice, soci√©t√©)
  - Output g√©n√©r√©
  - Contenu valide

- [ ] 75. CODE : Impl√©menter ExportFecCommand
  - `src/Command/ExportFecCommand.php`
  - Les tests doivent passer

**‚úì Validation Phase 8** : PHPStan + CS Fixer + Tests 100%

---

## üîß Phase 9 : Configuration & Int√©gration - TDD

- [ ] 76. TEST : Tests d'int√©gration pour configuration bundle
  - `tests/Functional/DependencyInjection/InvoiceBundleExtensionTest.php`
  - Chargement des param√®tres YAML
  - Valeurs par d√©faut
  - Services autowir√©s
  - Aliases corrects

- [ ] 77. CODE : Compl√©ter Configuration.php + services.yaml
  - `src/DependencyInjection/Configuration.php`
  - `config/services.yaml`
  - Tous les param√®tres YAML
  - Autowiring complet
  - Tags et Aliases
  - Les tests doivent passer

- [ ] 78. TEST : Tests pour sch√©ma Doctrine
  - `tests/Functional/Entity/SchemaValidationTest.php`
  - Validation du sch√©ma
  - Contraintes uniques
  - Index

- [ ] 79. CODE : Cr√©er les migrations Doctrine
  - Pour toutes les entit√©s
  - Script propre
  - Les tests doivent passer

- [ ] 80. TEST : Test d'int√©gration complet end-to-end
  - `tests/Functional/Integration/CompleteInvoiceWorkflowTest.php`
  - Cr√©er facture ‚Üí Finaliser ‚Üí Payer ‚Üí Export FEC
  - Workflow complet avec tous les services

**‚úì Validation Phase 9** : PHPStan + CS Fixer + Tests 100%

---

## üìö Phase 10 : Documentation & Validation finale

- [ ] 81. Mettre √† jour README.md
  - Installation
  - Configuration
  - Utilisation
  - Tests

- [ ] 82. Cr√©er USAGE.md
  - Exemples concrets
  - Cas d'usage
  - Extension

- [ ] 83. VALIDATION FINALE : PHPStan niveau 9
  - 0 erreurs
  - 0 warnings

- [ ] 84. VALIDATION FINALE : Couverture de code > 90%
  - `make test-coverage`
  - V√©rifier toutes les branches

---

## üìä Statistiques

- **Total t√¢ches** : 84
- **T√¢ches compl√©t√©es** : 0
- **Progression** : 0%

---

## üéØ Prochaine √©tape

üëâ **Phase 0 - T√¢che 1** : V√©rifier et ajuster phpstan.neon (niveau 9)

## üìê Principes TDD appliqu√©s

Pour chaque composant :
1. ‚úÖ **RED** : √âcrire le test (qui √©choue)
2. ‚úÖ **GREEN** : √âcrire le code minimum pour passer le test
3. ‚úÖ **REFACTOR** : Am√©liorer le code (DRY) sans casser les tests

**Important sur les interfaces :**
- Les interfaces ne sont **jamais cr√©√©es seules**
- Elles sont cr√©√©es **avec leur premi√®re impl√©mentation**
- Les tests de l'impl√©mentation **d√©finissent le contrat** de l'interface
- Exception : Interfaces sans impl√©mentation bundle (UserProviderInterface) ‚Üí impl√©ment√©es par l'app

Validation continue apr√®s chaque phase : PHPStan 9 + CS Fixer + Tests 100%
